# Excel WBS/ガントチャートテンプレート 仕様書 Ver. 0.3（2025-06-03）<-- バージョン更新

## 1. はじめに

本仕様書は、MD-WBS-Toolsプロジェクトと連携して使用されるExcel WBS/ガントチャートテンプレート（`samples/excel_templates/wbs-gantt-template.xlsx` を想定）の構造、主要な列定義、入力ルール、および計算ロジックについて定義します。
PowerShellスクリプト（`Convert-SimpleMdWbsToCsv.ps1`）は、このテンプレート仕様に適合するCSVファイルを出力します。

## 2. テンプレート全体の構成と操作セル

### 2.1. 主要な操作セル

以下のセルは、テンプレート全体の表示や計算に影響を与える重要な操作セルです。

* **E1セル: プロジェクト名（案件名）**
  * 内容: プロジェクトの名称を入力します。
  * 連携: `simple-md-wbs` のH1見出し（プロジェクト名）からCSV経由で設定されることを想定。
* **P1セル: 開始日（プロジェクト開始日）**
  * 内容: プロジェクト全体の開始日をYYYY-MM-DD形式で入力します。
  * 連携: ガントチャートの描画開始時期の基準となります。ユーザーがExcelテンプレート上で直接設定します。
* **P2セル: 基準日**
  * 内容: 進捗状況を評価するための基準日。通常は `=TODAY()` 関数が設定されています。
  * 連携: ガントチャートの「今日線」の表示、タスクの遅延計算などに使用されます。
* **P3セル: 週表示**
  * 内容: ガントチャート領域の表示開始位置を調整するためのオフセット値（単位：週）。
    * `0`: プロジェクト開始日（P1）が含まれる週の月曜日から表示。
    * `-1`: プロジェクト開始日（P1）の前の週の月曜日から表示。
  * 連携: ガントチャートの日付行の最初のセル（例: AB3セル）の日付計算に影響します。

### 2.2. 列のグループ化と主要表示列

本テンプレートは、情報量が多くなることと視認性への配慮から、一部の列がグループ化され、通常は主要な列のみが表示されるように設計されています。

* **F列, G列, H列のグループ化:**（先行タスク情報）
  * **F列: 先行有無**（CSVから入力orExcel数式）
  * **G列: 関連番号（先行タスクID）**（CSVから入力）
  * **H列: 先行後続タスク名**（CSVから入力）
  * **I列: 関連タスク有無表示**（主要表示列）
    * 内容: G列に有効な先行タスクIDが設定されていれば "○" などを表示。
    * **計算式（I5セル）: `=IF(ISBLANK(G5),"","○")`**

* **J列, K列, L列, M列のグループ化:**（遅延計算関連）
  * **J列: アクションプラン**（ユーザー入力欄）
    * 内容: タスクに関する具体的なアクションやメモを自由記述。
    * `simple-md-wbs`属性:「コメント」属性の主要な入力元/出力先。
  * **K列:（計算用 遅延影響評価など）**
    * **計算式（K5セル）: `=IF($Z5<>"",IF($W5>=$Z5,$W5-$Z5,$X5)*$Y5,0)`**
      * 依存列: W5（終了計画）、X5（日数計画）。**Y5, Z5 がCSVのどの列/ `simple-md-wbs` のどの属性に対応するか、またはExcel内での手入力/別計算なのか明確化が必要。**（例: Y5=進捗率、Z5=実績終了日）
  * **L列:（計算用 遅延日数1）**
    * **計算式（L5セル）: `=IF($K5>0,IF($Z5<>"",IF((IFERROR($Z5,P$1)+$K5)<P$2,P$2-($Z5+$K5),0),0),0)`**
  * **M列:（計算用 遅延日数2）**
    * **計算式（M5セル）: `=IF(AND(IFERROR(VALUE($X5),0),$Z5="",$V5<P$2),P$2-$V5,0)`**
  * **N列: 遅延日数表示**（主要表示列）
    * 内容: L列とM列の最大値を表示。
    * **計算式 (N5セル): `=MAX(L5:M5)`**

* **Q列のグループ化:**（最終更新日）
  * **Q列: 最終更新（日）**（主要表示列、かつユーザー入力欄）
    * 内容: タスク担当者が情報を更新した日付をYYYY-MM-DD形式で**手入力**します。
    * `simple-md-wbs`属性:「最終更新日」属性に対応。

### 2.3. 行のグループ化（VBAマクロによる表示最適化）

（変更なし）

## 3. 主要なWBSデータ列定義と計算ロジック

PowerShellスクリプトから出力されるCSVは、以下の列（またはこれに準ずる列）にデータを持ちます。
S列、T列、U列はユーザーが直接入力（さらにははCSVからインポート）する主要なデータ項目です。
V列、W列、X列は、S,T,U列の入力に基づいてExcelの計算式によって自動的に計算される計画値です。

### 3.1. ヘルパー列（非表示推奨）

* **JG列: S列が平日かの判定**
  * 式（JG5セル）: `=IF(ISBLANK(S5),"",IF(OR(WEEKDAY(S5,2)=6,WEEKDAY(S5,2)=7),FALSE,TRUE))`
* **JH列: T列が平日かの判定**
  * 式（JH5セル）: `=IF(ISBLANK(T5),"",IF(OR(WEEKDAY(T5,2)=6,WEEKDAY(T5,2)=7),FALSE,TRUE))`

### 3.2. 入力列（S, T, U）- CSVからの主要入力元 / ユーザー直接入力

* **S列: 開始入力**
  * 内容: タスクの開始予定日（ユーザー入力またはCSVから）。YYYY-MM-DD形式。
  * `simple-md-wbs`属性:「開始日（入力）」属性に対応。
* **T列: 終了入力**
  * 内容: タスクの終了予定日（ユーザー入力またはCSVから）。YYYY-MM-DD形式。
  * `simple-md-wbs`属性:「終了日（入力）」属性に対応。
* **U列: 日数入力**
  * 内容: タスクの所要見積日数（ユーザー入力またはCSVから）。数値。
    * **V列・W列の計算においては「実働日数（土日を含まない）」として主に解釈される。**
    * **X列の計算においては、S列・T列が土日にかかる場合はカレンダー日数として解釈される場合がある。**
  * `simple-md-wbs`属性:「日数（入力）」属性に対応。

### 3.3. 計画列（V, W, X）- Excel計算式による自動計算

* **V列: 開始計画**
  * **式（V5セル）: `=IF(NOT(ISBLANK(S5)),S5,IF(AND(NOT(ISBLANK(T5)),NOT(ISBLANK(U5))),IF(NOT(JH5),T5-U5+1,WORKDAY.INTL(T5,-U5+1,1)),""))`**
* **W列: 終了計画**
  * **式（W5セル）: `=IF(NOT(ISBLANK(T5)),T5,IF(AND(NOT(ISBLANK(S5)),NOT(ISBLANK(U5))),IF(NOT(JG5),S5+U5-1,WORKDAY.INTL(S5,U5-1,1)),""))`**
* **X列: 日数計画**
  * **式（X5セル）: `=IF(NOT(ISBLANK(U5)),U5,IF(AND(NOT(ISBLANK(S5)),NOT(ISBLANK(T5))),IF(S5<=T5,IF(OR(NOT(JG5),NOT(JH5)),T5-S5+1,NETWORKDAYS.INTL(S5,T5,1)),0),""))`**

### 3.4. その他の主要データ列と `simple-md-wbs` 属性のマッピング

以下は、PowerShellスクリプトが出力するCSVの列と、それに対応する `simple-md-wbs` 属性、およびExcelテンプレート上の想定列レターの例です。
**（このマッピングは `docs/10_requirements_definition.yaml` のCSV列定義と完全に一致させる必要があります）**

| CSV列ヘッダー（例）           | Excel列（想定） | `simple-md-wbs` 属性                     | 備考                                       |
|-------------------------------|-----------------|------------------------------------------|--------------------------------------------|
| タスクID                      | A               |（ツール自動生成: 表示用ソートキー）      |                                            |
| 大分類                        | B               | H2見出しテキスト                         |                                            |
| 中分類                        | C               | H3見出しテキスト                         |                                            |
| 小分類                        | D               | H4見出しテキスト                         |                                            |
| タスク名称                    | E               | H1見出しテキスト / リストアイテムテキスト|                                            |
| 先行有無                      | F               | 「関連タスクID」の有無からツールが判定   | "有", "無" など                            |
| 関連番号（先行タスクID）      | G               |（解決済みの先行タスクの表示用ソートキー）|                                            |
| 先行後続タスク名              | H               |（解決済みの先行タスクの名称）            |                                            |
| **アクションプラン**          | **J**           | **コメント**                             | ExcelのJ列をコメントの主たる入出力先とする |
| **担当組織**                  | **O**           | **担当組織**                             |                                            |
| **担当者**                    | **P**（※注1）  | **担当者**                               |                                            |
| **最終更新日**                | **Q**           | **最終更新日**                           | ユーザーがExcelで手入力、またはCSVから反映 |
| **開始日（入力）**            | **S**           | **開始日（入力）**                       |                                            |
| **終了日（入力）**            | **T**           | **終了日（入力）**                       |                                            |
| **日数（入力）**              | **U**           | **日数（入力）**                         |                                            |
| **進捗率**                    | **X**（※注2）  | **進捗率**                               | 文字列のまま（例: "50%", "0.5"）           |
| **開始日（実績）**            | **Y**（※注2）  | **開始日（実績）**                       |                                            |
| **状態**                      |（未定の列）     | **状態**                                 | ユーザー入力値を優先                       |
| ユーザー記述ID（元ID）        |（デバッグ用列） | ユーザー記述ID                           |                                            |
| 関連タスク種別                |（デバッグ用列） | 関連タスク種別                           | "先行", "後続"                             |
| 先行タスクユーザー記述ID（元）|（デバッグ用列） | 関連タスクID                             | 未解決のID                                 |
| アイテム種別（デバッグ用）    |（デバッグ用列） |（ツール内部判定）                        |                                            |

* **（※注1）Excelテンプレートの担当者列:** 画像では「担当者」が「担当組織」の右隣（O列）に見えましたが、CSV出力仕様と合わせるため、仮にP列としています。実際のテンプレートに合わせてください。
* **（※注2）Excelテンプレートの進捗率・開始日実績列:** 画像ではX列が進捗率、Y列が開始日実績に見えましたが、これも実際のテンプレートに合わせてください。
* **「状態」属性のCSV列:** `simple-md-wbs` に「状態」属性はありますが、Excelテンプレートのどの列に対応させるか（またはさせないか）を決定する必要があります。
* **K,L,M,N列の計算に必要なCSV列:** Y5, Z5セルが参照されています。これらがCSVのどの列（ひいては`simple-md-wbs`のどの属性）から来るのか、またはExcel内で別途計算されるのかを明確にする必要があります。

## 4. 推奨される運用方法

（変更なし）

## 5. 改訂履歴

| バージョン | 日付       | 変更者      | 変更内容                                                                                       |
|------------|------------|-------------|------------------------------------------------------------------------------------------------|
| 0.3        | 2025-06-03 | IT Legacy   | `simple-md-wbs`の新属性順序を反映。提供されたExcel計算式を詳細化。コントロールセル情報を追加。 |
| 0.2        | 2025-06-02 | IT Legacy   | Q列の運用を明確化等。                                                                          |
| 0.1        | 2025-06-01 | IT Legacy   | 初版ドラフト作成。                                                                             |
