# WBSタスク記法 仕様書（Ver.1.3）

## 1. はじめに

このドキュメントは、MD-WBS-Toolsプロジェクトで使用される「WBSタスク記法」の詳細な仕様を定義します。
この記法は、人間が読み書きしやすく、かつPowerShellスクリプトによる機械処理も可能な形式を目指しています。VS CodeなどのMarkdown`エディタ`での編集を主なユースケースとして想定しています。
このファイル自体が、WBSタスク情報だけでなく、ドキュメントタイトルや他の補足情報（例: AIへの指示プロンプト、変更履歴など）をMarkdown形式で含めることができるように設計されています。
**本WBSタスク記法は、プロジェクト計画の初期段階におけるトップダウン的な目標設定（例: 大分類や中分類への期日設定）から、詳細なタスクのボトムアップ的な洗い出しと属性付与まで、プロジェクトのさまざまなフェーズと計画スタイルに対応できる柔軟性を持つことを意図しています。**

## 2. ファイル形式とエンコーディング

* **ファイル拡張子**: `.md`
* **エンコーディング**: UTF-8（BOMなしを推奨）

## 3. 全体構造と処理対象セクション

PowerShellスクリプトがWBSタスク情報を抽出する際のファイル全体の解釈ルールは以下の通りです。

### 3.1. フロントマター（オプション）

* ファイルの絶対先頭（最初の見出しレベル1よりも前）には、YAML形式のフロントマターを記述できます。

    ```yaml
    ---
    project_name: "My Awesome Project"
    base_date: "2025-06-01"
    version: "1.0"
    author: "Your Name"
    ---
    ```

* **初期の扱い（ロードマップ フェーズ0-1）**: スクリプトはフロントマターが存在してもエラーとせず読み飛ばすか、`project_name` や `base_date` などの定義済みキーのみをオプションとして読み取ります。
* **将来的な扱い**: フロントマターに記述された情報は、Excel出力時のプロジェクト情報やMarkwhen生成時の基準日などに活用される予定です。

### 3.2. 見出しレベル1（`#`）の扱い

* ファイル内で最初に出現する見出しレベル1（`#`）およびその配下の内容は、**WBSタスク情報としては無視されます**。
* これは、Markdownドキュメント全体のタイトルとして利用することを想定しています。

### 3.3. 「タスク情報」セクションの特定（処理対象）

* ファイル内で、見出しレベル2（`##`）のテキストが正確に **`タスク情報`** という文字列であるセクションを探します。
* この `## タスク情報` セクションの直後から、次の見出しレベル1またはレベル2が出現するまでの間にあるMarkdownの無順序リストが、WBSタスクデータの処理対象となります。
* ファイル内に `## タスク情報` という見出しが存在しない場合、そのファイルからはWBSタスク情報は抽出されません（またはエラーとして扱います）。
* `## タスク情報` が複数存在する場合、最初に出現したもののみを処理対象とするか、すべてを処理対象とするかはスクリプトの実装によりますが、現状は**最初の一つのみを処理対象とする**ことを推奨します。

### 3.4. その他のセクションの扱い

* 上記3.2および3.3で指定された箇所以外のすべての内容（他の見出しレベル2のセクション、たとえば `## 生成AIプロンプト` や `## 変更履歴`、本文テキストなど）は、**WBSタスク情報としては無視されます**。

## 4. 「タスク情報」セクション内のWBSタスク記法

`## タスク情報` セクション内に記述されるWBSタスクは、以下のルールに従います。

### 4.1. 基本構造

* 各タスクは、Markdownの**無順序リストアイテム**として表現します。
  * リストマーカーはハイフン（`-`）またはアスタリスク（`*`）の後に半角スペースを1つ以上記述します。
* タスクの階層構造は、リストアイテムの**インデント**によって表現します。
  * インデントの深さ（スペースの数）でレベルを判断します。推奨は**半角スペース2つまたは4つ**を1レベルとすることですが、スクリプトは相対的なインデント差を解釈します。親子関係でインデントが深くなっていれば認識します。
* **行末コメント**: 各リストアイテムの行末には、` # `（半角スペース、シャープ記号、半角スペース）に続けてコメントを記述できます。このコメント部分は、スクリプトによるタスクデータの解釈からは除外されます。コメントがない場合は、` # ` 以降は存在しません。
  * 例: `- タスク名,2025-01-01 # これはコメントです`

### 4.2. データ要素とカンマ区切り形式

各リストアイテムのテキスト部分（行末コメントがある場合は、それより前の部分）は、以下の要素をカンマ (`,`) で区切って記述します。要素の順序は固定です。

```plaintext
1. `名称` (文字列, **必須**)
2. `終了入力` (日付文字列 YYYY-MM-DD, 省略可)
3. `日数入力` (文字列 例: `5d`, 省略可)
4. `依存関係種別` (文字列 `先行` または `後続`, 省略可)
5. `依存先行タスク指定` (文字列, `依存関係種別`が`先行`の場合、先行するタスクの「タスクID」または「名称」を指定、省略可。`依存関係種別`が`後続`の場合は通常指定不要)
6. `状態` (文字列 `未着手`, `進行中`, `完了`, 省略可, デフォルト: `未着手`)
7. `進捗率` (文字列 例: `50%` または数値 `0.5`, 省略可, デフォルト: `0%` または `0`)
8. `担当者` (文字列, 省略可)
9. `担当組織` (文字列, 省略可)
10. `固定開始日` (日付文字列 YYYY-MM-DD, 省略可)
11. `最終更新日` (日付文字列 YYYY-MM-DD, 省略可)
```

> **注記:** このデータ要素の並びは、WBSの階層（大分類、中分類、詳細タスク）に関わらず、全てのリストアイテムに適用可能です。**これにより、プロジェクト計画の初期段階で大分類や中分類といった上位カテゴリに対して目標期日、所要期間、担当者、状態などを直接設定することができます。これらの上位カテゴリの属性は、配下タスクの計画・実行における制約や目標として機能します。一方で、詳細タスクの属性は、具体的な作業内容を示します。このように、トップダウン的な計画とボトムアップ的な詳細化の両方のアプローチをサポートします。**

#### 各要素の詳細

* **名称**: タスクやカテゴリの名称。カンマを含める場合はダブルクォーテーションで囲むなどの考慮は現状不要（シンプルさを優先）。
* **終了入力**: タスクの目標完了日。`YYYY-MM-DD` 形式。
* **日数入力**: タスクの所要実作業日数。数値の後に `d` を付与（例: `3d`, `10d`）。
* **依存関係種別**:
  * `先行`: このタスクが「関連タスク名称」に依存することを示す。
  * `後続`:「依存先行タスク指定」で特定されるタスクがこのタスクに依存することを示す（このケースでは通常、関連タスク側で`先行`を指定するため、この要素は空欄または省略されることが多い）。
* **`依存先行タスク指定`**:
  * **このタスクが依存する先行タスクを特定するための情報。**
  * **「タスクID」形式の文字列（例: `T1.2.3`, `task-005`）または先行タスクの「名称」を文字列で指定します。**
  * スクリプトは、まずこれが既存のタスクIDと一致するかを確認し、一致しない場合はタスク名称として解決を試みます。
  * Excelから変換された場合は、基本的に先行タスクのIDがここに設定されます。手入力で名称を使うことも可能です。
* **状態**: `未着手`, `進行中`, `完了` のいずれか。
* **進捗率**: `0%`～`100%` の形式、または `0`～`1.0` の小数。
* **固定開始日**: タスクの開始日が固定されている場合の日付。`YYYY-MM-DD` 形式。
* **最終更新日**: タスク情報の最終更新日。`YYYY-MM-DD` 形式。

### 4.3. 省略ルール

* 省略可能な要素の値を指定しない場合でも、後続に値を指定する要素がある場合は、その位置を示すためにカンマを残します。
  * 例: `タスクC,,,先行,タスクA`（`終了入力`と`日数入力`を省略）
  * 例: `タスクC,,,先行,T101`（`終了入力`と`日数入力`を省略し、先行タスクをIDで指定）
  * 例: `タスクE,,,先行,先行タスクの名称`（先行タスクを名称で指定）
* 行の末尾から連続して要素を省略する場合、最後の指定要素以降のカンマは記述不要です。
  * 例: `タスクD,2025-07-15,3d`（`依存関係種別`以降すべて省略）
* `名称` 以外のすべての要素を省略することも可能です。その場合は `名称` のみ記述します。

### 4.4. 階層表現の詳細

```md
- 大項目A # 全体を統括
  - 中項目A1 # サブカテゴリ1
    - 小タスクA1a,2025-08-01,5d,,,,,,,,,2025-07-20 # 初期タスク
    - 小タスクA1b,2025-08-10,3d,先行,小タスクA1a  # A1aに依存
    - 小タスクA1c,2025-08-15,2d,先行,T1.1.1     # ID T1.1.1 (A1aのIDと仮定) に依存
  - 中項目A2 # サブカテゴリ2
    - 小タスクA2a # 属性なしタスク
- 大項目B # 別の大きなカテゴリ
```

* `大項目A` がレベル1。
* `中項目A1`, `中項目A2` がレベル2（大項目Aの子）。
* `小タスクA1a`, `小タスクA1b` がレベル3（中項目A1の子）。

## 5. 記述例

### 5.1. シンプルな例（`## タスク情報` セクションのみ）

```markdown
## タスク情報

- プロジェクト初期化
- 要件定義,2025-06-15,5d,,,未着手,0%
- 環境構築,2025-06-10,3d,,,進行中,50%,田中一郎,開発チーム,,2025-06-01
- 設計フェーズ
- 基本設計,2025-06-30,10d,先行,要件定義
```

### 5.2. 完全なファイル構造の例

```markdown
---
project_name: "サンプルプロジェクト"
base_date: "2025-01-01"
---

# WBSタスク記法 パターンサンプル

このドキュメントはWBSタスク記法の様々なパターンを網羅し、一部矛盾を含む例も示します。

## メモエリア

このエリアはスクリプトに無視されるため、自由なメモが可能です。
- TODO: 依存関係の循環チェック機能の実装検討。

## タスク情報

# レベル0: トップレベルタスク (ID: T1)
- 正常タスク_全属性指定,2025-01-31,5d,先行,T2,完了,100%,山田太郎,開発Aチーム,2025-01-15,2025-01-10 # 全て指定
- 正常タスク_名称のみ # 他の属性は全てデフォルト
- 正常タスク_終了日と日数のみ,2025-02-10,8d # 逆線表計算の期待
- 正常タスク_固定開始日と日数のみ,,,,,,山田次郎,開発Bチーム,2025-02-01 # 順線表計算の期待 (日数未指定なので1d?) -> 修正: 日数入力も必要
- 正常タスク_固定開始日と日数_修正,2025-02-10,3d,,,,,山田次郎,開発Bチーム,2025-02-01 # 順線表計算
- 正常タスク_固定期間,2025-02-20,,,,,,佐藤花子,設計チーム,2025-02-15 # 固定開始と終了 (日数自動計算)
- 正常タスク_進捗率数値指定,,,,,,進行中,0.75 # 進捗率が数値
- 正常タスク_末尾カンマ省略,2025-03-05,5d # 依存関係以降省略

  # レベル1: T1の子 (ID: T1.1, T1.2 ...)
  - 正常子タスク_依存_ID指定,2025-02-05,3d,先行,T1 # T1(正常タスク_全属性指定)に依存 (仮のID)
  - 正常子タスク_依存_名称指定,2025-02-15,5d,先行,正常タスク_全属性指定 # 名称で依存
  - 正常孫タスク_インデント2段 # (ID: T1.2.1)
    - 正常曾孫タスク_インデント3段,,,,,,未着手 # (ID: T1.2.1.1)

- 矛盾タスク_日付形式不正,INVALID-DATE,3d # 終了日の形式が不正
- 矛盾タスク_日数形式不正,2025-03-10,INVALID-D # 日数の形式が不正 (dがない)
- 矛盾タスク_依存種別不正,2025-03-15,2d,不明,T1 # 依存種別が「先行」でも「後続」でもない
- 矛盾タスク_依存先不明_ID指定,2025-03-20,1d,先行,存在しないID # 存在しないIDへの依存
- 矛盾タスク_依存先不明_名称指定,2025-03-25,2d,先行,存在しないタスク名 # 存在しない名称への依存
- 矛盾タスク_状態不正,,,,,,不明な状態 # 状態が定義されていない
- 矛盾タスク_進捗率形式不正,,,,,,進行中,INVALID-PROGRESS # 進捗率の形式が不正
- 矛盾タスク_固定開始日より終了日が過去,2025-03-01,5d,,,,,,,2025-03-10 # 固定開始日 > 終了入力
- 矛盾タスク_名称なし_これはエラーとすべきか,(これは空の名称と解釈されるか、エラーか。仕様上は必須なのでエラー)
- 矛盾タスク_循環依存A,2025-04-01,1d,先行,矛盾タスク_循環依存B # 循環依存の可能性
- 矛盾タスク_循環依存B,2025-04-02,1d,先行,矛盾タスク_循環依存A # 循環依存の可能性
- 正常タスク_アスタリスクマーカー* アスタリスクで開始されたタスク,2025-04-05,1d # アスタリスクもOK
- 正常タスク_スペースインデント多め    -   かなりインデントされてるタスク,2025-04-10,2d # インデントの量
- 正常タスク_コメントのみの行は無視されるべき

# この行はタスクではない (リストアイテムではない)
- 正常タスク_最終行,2025-04-15,1d # これが最後の処理対象タスク

## 別の見出し2 (ここは無視される)

このセクションはWBSタスク情報としては扱われません。
- 無視されるリストアイテム1
- 無視されるリストアイテム2

```

## 6. AI生成用プロンプトテンプレート (低負荷版)

---

### ENGLISH PROMPT TEMPLATE FOR AI（Low-resource models）

```plaintext
Convert the following task list into a specific Markdown WBS format. Follow these rules strictly:

1. **Overall Structure**:
    * The WBS data MUST be under a Markdown heading `## Task Information`.
    * Each task is a Markdown list item starting with `-`（hyphen and a space）or `*` (asterisk and a space).
    * Hierarchy is shown by indentation（use 2 or 4 spaces for each level deeper. The amount of spaces MUST be consistent within the same document.）.

2. **Task Item Format（Comma-Separated Values）**:
    * Each list item, after the `-` or `*`, contains comma-separated fields in this EXACT order:
        1. `Name`（string, REQUIRED）
        2. `EndDate`（date YYYY-MM-DD, optional）
        3. `Duration`（string like `5d`, optional）
        4. `DependencyType`（string `先行` for "predecessor" or `後続` for "successor", optional. **Note: These are Japanese keywords.**)
        5. `PredecessorTaskIdentifier`（string, **Task ID (e.g., `T1.2`) or Name (e.g., `Initial Setup`) of the task it depends on**, optional, use if DependencyType is `先行`）
        6. `Status`（string `未着手` for "pending", `進行中` for "in progress", `完了` for "completed", optional, defaults to `未着手`. **Note: These are Japanese keywords.**)
        7. `Progress`（string like `50%` or number `0.5`, optional, defaults to `0%`）
        8. `Assignee`（string, optional）
        9. `Organization`（string, optional）
        10. `FixedStartDate`（date YYYY-MM-DD, optional）
        11. `LastUpdatedDate`（date YYYY-MM-DD, optional）

3. **Omitting Optional Fields**:
    * If an optional field in the middle is empty, keep its comma placeholder. Example: `Task Name,,,先行,T1.2.1,,,,,,` (Dependency on Task ID T1.2.1)
    * If trailing optional fields are empty, you can omit the trailing commas. Example: `Task Name,2023-12-31,5d`

4. **Example Task Lines**:
    * Dependency by Name: `- Task A,2023-10-31,5d,先行,Task B,進行中,25%,John Doe,Dev Team,2023-10-01,2023-09-15 # Depends on 'Task B' by name`
    * Dependency by ID:   `- Task C,2023-11-15,3d,先行,T1.2,未着手,0%,Jane Roe,QA Team,,,2023-10-20 # Depends on Task ID 'T1.2'`

**Input Task List:**
[Paste the task list you want to convert to the Markdown WBS format here. Plain text or other formats are acceptable.]
```

### Expected Output（Example Snippet under `## Task Information`）

```markdown
## Task Information

- Parent Task 1 # Main category
  - Child Task 1A,2025-01-15,5d,,,未着手,0% # Initial sub-task (ID might be T1.1 internally)
  - Child Task 1B,2025-01-20,3d,先行,Child Task 1A,進行中,50% # Depends on 'Child Task 1A' by name
  - Child Task 1C,2025-01-22,2d,先行,T1.1,完了,100% # Depends on Task ID 'T1.1' (assuming T1.1 is Child Task 1A)
```

---

### 日本語プロンプトテンプレート（低負荷版）

```plaintext
以下のタスクリストを、指定されたMarkdown WBS形式に変換してください。ルールを厳密に守ってください。

1. **全体構造**:
    * WBSデータは必ず `## タスク情報` というMarkdown見出しの下に記述してください。
    * 各タスクは `-`（ハイフンとスペース）または `*` (アスタリスクとスペース) で始まるMarkdownリスト項目です。
    * 階層はインデント（各レベルでスペース2つまたは4つ。スペースの量はドキュメント内で一貫している必要があります）で表現します。

2. **タスク項目フォーマット（カンマ区切り）**:
    * 各リスト項目の `-` または `*` の後には、以下の要素をこの順番でカンマ区切りで記述します。
        1. `名称`（文字列, **必須**）
        2. `終了入力`（日付 YYYY-MM-DD, 省略可）
        3. `日数入力`（文字列 例: `5d`, 省略可）
        4. `依存関係種別`（文字列 `先行` または `後続`, 省略可）
        5. **`依存先行タスク指定`**（文字列, **先行するタスクの「タスクID」または「名称」を指定**, 省略可, `依存関係種別`が`先行`の場合使用）
        6. `状態`（文字列 `未着手`, `進行中`, `完了`, 省略可, デフォルト: `未着手`）
        7. `進捗率`（文字列 例: `50%` または数値 `0.5`, 省略可, デフォルト: `0%`）
        8. `担当者`（文字列, 省略可）
        9. `担当組織`（文字列, 省略可）
        10. `固定開始日`（日付 YYYY-MM-DD, 省略可）
        11. `最終更新日`（日付 YYYY-MM-DD, 省略可）

3. **省略可能なフィールドの扱い**:
    * 途中の省略可能なフィールドが空の場合でも、カンマは残してください。例: `タスク名,,,先行,依存タスク名,,,,,,`
    * 末尾の連続する省略可能なフィールドが空の場合、末尾のカンマは省略可能です。例: `タスク名,2023-12-31,5d`

4. **タスク行の例**:
    * 有効なタスク行: `- タスクA,2023-10-31,5d,先行,タスクB,進行中,25%,山田太郎,開発チーム,2023-10-01,2023-09-15`
    * 名称のみのタスク: `- タスク名`
    * 複数のフィールドを省略したタスク: `- タスクC,,,先行,タスクA`
    * タスクIDで依存関係を指定: `- タスクE,,,先行,T101`

**入力タスクリスト:**
[ここにAIに変換させたいタスクリストをプレーンテキストや別の形式で貼り付ける]
```

### 期待される出力（`## タスク情報` 配下の抜粋例）

```markdown
## タスク情報

- 親タスク1
  - 子タスク1A,2025-01-15,5d,,,未着手,0%
  - 子タスク1B,2025-01-20,3d,先行,子タスク1A,進行中,50%
```

---

## 変更履歴

| 日付       | バージョン | 担当者      | 変更内容                                     |
|------------|------------|-------------|----------------------------------------------|
| 2025-05-29 | 1.4        | AI/ユーザー | AIプロンプトの依存関係指定をID/名称に対応. |
| 2025-05-29 | 1.3        | AI/ユーザー | 上位カテゴリへの属性付与の明確化、トップダウン/ボトムアップ両アプローチへの対応を仕様に明記。 |
| 2025-05-29 | 1.2        | AI/ユーザー | 行末コメント機能の追加、依存関係指定の柔軟化 |
